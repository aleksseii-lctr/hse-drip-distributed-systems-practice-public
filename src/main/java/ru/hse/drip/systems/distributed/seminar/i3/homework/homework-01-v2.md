# Домашнее задание №1: Распределённый broadcast чат с балансировкой нагрузки

**Дедлайн:** 2 недели с момента выдачи  
**Максимальный балл:** 10 баллов

## Цель работы

Реализовать распределённую систему чата, включающую:
- Несколько серверных узлов (нод) для обработки клиентских подключений
- Балансировщик нагрузки с проверкой состояния серверов
- Клиентское приложение с автоматическим переподключением

Система должна обеспечивать отказоустойчивость и горизонтальное масштабирование.

## Функциональные требования

### Что должна уметь система:

1. **Балансировка нагрузки:**
   - Распределять подключения клиентов между несколькими серверами
   - Перенаправлять клиентов только на работающие серверы
   - Автоматически обнаруживать добавление/удаление серверов без перезапуска
   - Исключать упавшие серверы из балансировки

2. **Обмен сообщениями:**
   - Клиенты отправляют и получают сообщения в общий чат
   - Сообщения доставляются всем клиентам, независимо от сервера подключения
   - Отсутствие дублирования сообщений
   - Серверы узнают о составе кластера через балансировщик

3. **Отказоустойчивость:**
   - При падении сервера клиенты автоматически подключаются к другому живому серверу через балансировщик
   - При падении сервера остальные серверы продолжают корректно обмениваться сообщениями
   - Работа системы гарантируется при падении любого числа серверов (пока остаётся хотя бы один)

## Структура задания

### Задача 1: Балансировщик нагрузки с health-check и масштабируемостью (3 балла)

**Требования:**

1. **TCP-прокси:**
   - Принимает клиентские подключения на порту
   - Перенаправляет соединения на один из живых серверов
   - Список серверов (host:port) хранится в конфиге

2. **Round-Robin:**
   - Реализовать алгоритм Round-Robin для распределения

3. **Health-check:**
   - Периодически (каждые 5–10 с) устанавливать TCP-соединение к каждому серверу
   - Исключать недоступные серверы из списка живых

4. **Масштабируемость:**
   - Балансировщик каждые 30 с перечитывает конфиг и автоматически обнаруживает новые/удалённые сервера

**Критерии (3 балла):**
- Алгоритм Round-Robin (до 1 балла)
- Health-check через TCP-сокеты (до 1 балла)
- Автообнаружение серверов из конфига (до 1 балл)

### Задача 2: Межсерверная синхронизация сообщений (4 балла)

** 1. Обновление состава кластера:**
- Балансировщик отправляет серверам обновления списка живых узлов после каждого health-check
- Формат сообщения от балансировщика:
```json
{
  "type": "SERVER_LIST_UPDATE",
  "servers": [
    {"serverId":"A","host":"localhost","port":9001},
    {"serverId":"B","host":"localhost","port":9002}
  ]
}
```

** 2. Межсерверное взаимодействие:**
   - Каждый сервер устанавливает TCP-соединения только с теми peer-узлами, что прислал балансировщик
   - На данном этапе достаточно хранить все данные только в памяти.
   - Формат уведомления о сообщении от клиента к серверу:
      ```json
      {
        "type": "CLIENT_MESSAGE",
        "username": "alice",
        "content": "hello",
        "timestamp": 1634567890
      }
      ```
   - Формат уведомления о сообщении сервера к peer-узлам:
      ```json
      {
        "type": "CHAT_MESSAGE",
        "messageId": "uuid",
        "serverId": "A",
        "username": "alice",
        "content": "hello",
        "timestamp": 1634567890
      }
      ```

** 3. Распространение сообщений (2 балла):**
- При сообщении от клиента: рассылка всем локальным клиентам и пересылка всем peer-узлам
- При сообщении от peer: рассылка только локальным клиентам

** 4. Дедупликация сообщений (1 балл):**
   - In-memory хранилище messageId с TTL = 5 минут
   - Фильтрация дубликатов и периодическая очистка устаревших id (каждую минуту)

**5. Обработка обновлений списка узлов (1 балл):**
- Перестраивать соединения с другими серверами при обновлении списка живых серверов после получения `SERVER_LIST_UPDATE`. (удалять соединения с мертвыми серверами, выстраивать соединения с новыми живыми серверами)

**Критерии оценки:**
- Алгоритм распространения сообщений (2 балла)
- Эффективная дедупликация in-memory (1 балл)
- Корректная обработка обновлений списка узлов от балансировщика (1 балл)

### Задача 3: Отказоустойчивость клиента (3 балла)

1. **Автоматическое переподключение при падении сервера:**
   - Если клиент теряет соединение с сервером, он автоматически подключается к балансировщику
   - Балансировщик перенаправляет его на другой живой сервер
   - Процесс прозрачен: пользователь продолжает вводить сообщения без перерывов

2. **Graceful degradation:**
   - Если все сервера недоступны — выводится "Нет доступных серверов. Повторить попытку через 10 секунд."
   - Автоматические повторные попытки каждые 10 секунд без вмешательства пользователя

**Критерии оценки:**
- Автоматическое переподключение при падении сервера через балансировщик (2 балла)
- Реализация Graceful degradation (1 балл)

## Технические требования

- Язык: Java (стандартная библиотека)
- Хранить все данные в памяти, не использовать сторонних хранилищ.
- Thread-safe коллекции и `ExecutorService` для пулов потоков

## Формат сдачи

### Состояние репозитория
 
1. **README.md:** архитектура, форматы сообщений, инструкции по запуску. Приложение базовых промптов для LLM при использовании в решении ДЗ.
2. **demo-scenario.md:** текстовое описание шагов демонстрации работы системы, описание для демонстрации всей реализованной функциональности.
3. **Структура репозитория на усмотрение студента.**
4. **Открытый Pull Request в master/main ветку.**

### Сдача ДЗ преподавателю

1. Запись в Google Calendar на проверку ДЗ [по ссылке](https://calendar.app.google/vRJnSCo3MyVDff1SA). Записываться на слот необходимо не позднее, чем за 12 часов до слота.
2. Краткий созвон с преподавателем:
   - Демонстрация функциональности работы приложения
   - Защита работы и ответы на вопросы по работе
   - Ответы на дополнительные вопросы
   - Выставление оценки за домашнюю работу по 10-бальной шкале
3. Дедлайн сдачи преподавателю: 13.09.2025, 9:30 am
